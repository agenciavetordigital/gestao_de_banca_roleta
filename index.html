<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Banca para Roleta</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f3f4f6; }
        .card { background-color: #1f2937; border-radius: 0.75rem; padding: 1.5rem; border: 1px solid #374151; }
        .btn { color: white; font-weight: 600; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: background-color 0.3s ease, transform 0.1s ease; border: none; cursor: pointer; }
        .btn:disabled { background-color: #4b5563; cursor: not-allowed; }
        .btn:active:not(:disabled) { transform: scale(0.98); }
        .btn-green { background-color: #16a34a; } .btn-green:hover:not(:disabled) { background-color: #15803d; }
        .btn-red { background-color: #dc2626; } .btn-red:hover:not(:disabled) { background-color: #b91c1c; }
        .btn-blue { background-color: #2563eb; } .btn-blue:hover:not(:disabled) { background-color: #1d4ed8; }
        .btn-primary { background-color: #3b82f6; } .btn-primary:hover:not(:disabled) { background-color: #2563eb; }
        .input-field { background-color: #374151; border: 1px solid #4b5563; color: #f3f4f6; border-radius: 0.5rem; padding: 0.75rem; width: 100%; }
        .input-field:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px #1e40af; }
        .hidden { display: none; }
        .status-green { color: #22c55e; } .status-red { color: #ef4444; }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- TELA DE AUTENTICAÇÃO -->
    <div id="auth-container" class="max-w-md mx-auto hidden">
        <div class="card">
            <div id="login-view">
                <h2 class="text-2xl font-bold text-center mb-6">Login</h2>
                <form id="login-form" class="space-y-4">
                    <div><label for="login-email" class="block text-sm font-medium text-gray-300 mb-2">Email</label><input type="email" id="login-email" class="input-field" required></div>
                    <div><label for="login-password" class="block text-sm font-medium text-gray-300 mb-2">Senha</label><input type="password" id="login-password" class="input-field" required></div>
                    <button type="submit" class="btn btn-primary w-full">Entrar</button>
                    <p id="auth-error" class="text-red-500 text-sm text-center h-4"></p>
                </form>
                <p class="text-center mt-4 text-sm">Não tem uma conta? <a href="#" id="show-register-link" class="font-semibold text-blue-400 hover:underline">Cadastre-se</a></p>
            </div>
            <div id="register-view" class="hidden">
                <h2 class="text-2xl font-bold text-center mb-6">Criar Conta</h2>
                <form id="register-form" class="space-y-4">
                    <div><label for="register-email" class="block text-sm font-medium text-gray-300 mb-2">Email</label><input type="email" id="register-email" class="input-field" required></div>
                    <div><label for="register-password" class="block text-sm font-medium text-gray-300 mb-2">Senha</label><input type="password" id="register-password" class="input-field" required></div>
                    <button type="submit" class="btn btn-primary w-full">Cadastrar</button>
                    <p id="register-message" class="text-green-500 text-sm text-center h-4"></p>
                </form>
                <p class="text-center mt-4 text-sm">Já tem uma conta? <a href="#" id="show-login-link" class="font-semibold text-blue-400 hover:underline">Faça o login</a></p>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard-container" class="max-w-7xl mx-auto hidden">
        <!-- O conteúdo será injetado aqui pelo JS -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (!window.supabase) {
                console.error('Erro: Biblioteca Supabase não carregada.');
                alert('Erro ao carregar o Supabase. Verifique sua conexão ou tente novamente mais tarde.');
                return;
            }
            const { createClient } = supabase;
            // Para produção no Vercel, configure variáveis de ambiente no painel do Vercel e use um build step para injetar.
            // Aqui, mantemos hardcoded com aviso: não commite chaves em produção!
            const supabaseUrl = 'https://dekubpsswkfrtotwljvf.supabase.co'; // Use process.env.SUPABASE_URL em um setup com build
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRla3VicHNzd2tmcnRvdHdsanZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNzYyOTAsImV4cCI6MjA3MzY1MjI5MH0.Winuq2LIkaGt1sGNXUhi__Q5_AczyxKAYQ_ORABoPTk'; // Use process.env.SUPABASE_KEY
            const db = createClient(supabaseUrl, supabaseKey);

            const state = {
                currentUser: null,
                currentBanca: null,
                jogadas: [],
                metasDiarias: []
            };

            let isRendering = false;

            const authContainer = document.getElementById('auth-container'), dashboardContainer = document.getElementById('dashboard-container');
            const loginForm = document.getElementById('login-form'), registerForm = document.getElementById('register-form');
            const showRegisterLink = document.getElementById('show-register-link'), showLoginLink = document.getElementById('show-login-link');
            const authErrorEl = document.getElementById('auth-error'), registerMessageEl = document.getElementById('register-message');

            const formatCurrency = (v) => (v === null || v === undefined ? 0 : v).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
            const getLocalDateString = (d) => {
                const date = d ? new Date(d) : new Date();
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
            };

            function updateState(newState) {
                Object.assign(state, newState);
                renderAll();
            }

            async function loadDashboardData() {
                if (!state.currentUser) {
                    alert('Usuário não autenticado. Faça login novamente.');
                    return;
                }
                try {
                    const { data: bancaData, error: bancaError } = await db.from("bancas").select("*").eq("user_id", state.currentUser.id).single();
                    if (bancaData) {
                        updateState({ currentBanca: bancaData });
                    } else if (!bancaError || bancaError.code === 'PGRST116') {
                        const { data: newBanca, error: insertError } = await db.from("bancas").insert({
                            user_id: state.currentUser.id,
                            nome_banca: "Banca Principal",
                            valor_inicial: 100,
                            meta_diaria_percentual: 25
                        }).select().single();
                        if (insertError) throw new Error('Erro ao criar nova banca: ' + insertError.message);
                        updateState({ currentBanca: newBanca });
                    } else {
                        throw new Error('Erro ao carregar banca: ' + bancaError.message);
                    }
                    if (!state.currentBanca) throw new Error('Não foi possível carregar ou criar a banca.');

                    const [jogadasRes, metasRes] = await Promise.all([
                        db.from("jogadas").select("*").eq("banca_id", state.currentBanca.id).order("data_jogada", { ascending: false }),
                        db.from("metas_diarias").select("*").eq("banca_id", state.currentBanca.id).order("data", { ascending: true })
                    ]);
                    if (jogadasRes.error) throw new Error('Erro ao carregar jogadas: ' + jogadasRes.error.message);
                    if (metasRes.error) throw new Error('Erro ao carregar metas: ' + metasRes.error.message);
                    updateState({ jogadas: jogadasRes.data || [], metasDiarias: metasRes.data || [] });
                } catch (error) {
                    console.error(error);
                    dashboardContainer.innerHTML = `<p class="text-center text-red-500">Erro ao carregar dados: ${error.message}. Tente novamente.</p>`;
                }
            }

            function renderAll() {
                if (isRendering) return;
                isRendering = true;
                requestAnimationFrame(() => {
                    try {
                        if (!state.currentBanca) {
                            dashboardContainer.innerHTML = `<p class="text-center text-red-500">Não foi possível carregar dados.</p>`;
                            return;
                        }
                        if (document.getElementById('dashboard-container').innerHTML.trim() === '') {
                            dashboardContainer.innerHTML = `
                                <header class="mb-8 flex flex-wrap justify-between items-center gap-4">
                                    <div><h1 class="text-3xl md:text-4xl font-bold text-white"><i class="fas fa-compact-disc mr-3 text-red-500"></i>Gestão de Banca</h1><p id="user-email-display" class="text-gray-400 mt-2 text-sm">Logado como: ${state.currentUser.email}</p></div>
                                    <button id="logout-btn" class="btn btn-red"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button>
                                </header>
                                <section id="metrics-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6 mb-8"></section>
                                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                                    <div class="lg:col-span-1 space-y-8">
                                        <div id="settings-container" class="card"></div>
                                        <div id="daily-goal-container" class="card"></div>
                                        <div id="bet-form-container" class="card"></div>
                                    </div>
                                    <div id="bets-history-container" class="lg:col-span-2 card"></div>
                                </div>
                                <div id="projection-container" class="card mb-8"></div>
                            `;
                        }
                        renderMetrics();
                        renderSettings();
                        renderDailyGoal();
                        renderBetForm();
                        renderBets();
                        renderProjection();
                        setupEvents();
                    } finally {
                        isRendering = false;
                    }
                });
            }

            function renderMetrics() {
                const cycleProfit = state.jogadas.reduce((acc, j) => acc + (j.retorno - j.valor_apostado), 0);
                const totalStaked = state.jogadas.reduce((acc, j) => acc + j.valor_apostado, 0);
                const wonPlays = state.jogadas.filter(j => j.retorno > j.valor_apostado).length;
                const currentBankroll = state.currentBanca.valor_inicial + cycleProfit;
                let totalProfitAllTime = cycleProfit;
                state.metasDiarias.forEach(meta => { totalProfitAllTime += meta.lucro_final; });
                const roi = totalStaked > 0 ? (cycleProfit / totalStaked) * 100 : 0;
                const winRate = state.jogadas.length > 0 ? (wonPlays / state.jogadas.length) * 100 : 0;
                document.getElementById('metrics-container').innerHTML = `
                    <div class="card"><h3 class="text-sm font-medium text-gray-400">BANCA INICIAL</h3><p class="text-2xl font-semibold mt-2">${formatCurrency(state.metasDiarias[0]?.banca_inicial || state.currentBanca.valor_inicial)}</p></div>
                    <div class="card"><h3 class="text-sm font-medium text-gray-400">BANCA ATUAL</h3><p class="text-2xl font-semibold mt-2">${formatCurrency(currentBankroll)}</p></div>
                    <div class="card"><h3 class="text-sm font-medium text-gray-400">LUCRO TOTAL</h3><p class="text-2xl font-semibold mt-2">${formatCurrency(totalProfitAllTime)}</p></div>
                    <div class="card"><h3 class="text-sm font-medium text-gray-400">ROI DO CICLO</h3><p class="text-2xl font-semibold mt-2">${roi.toFixed(2)}%</p></div>
                    <div class="card"><h3 class="text-sm font-medium text-gray-400">WIN RATE DO CICLO</h3><p class="text-2xl font-semibold mt-2">${winRate.toFixed(2)}%</p></div>
                `;
            }
            function renderSettings() {
                document.getElementById('settings-container').innerHTML = `
                    <h2 class="text-xl font-bold mb-4">Configurações</h2>
                    <div class="space-y-4">
                        <div><label for="bankroll-input" class="block text-sm font-medium text-gray-300 mb-2">Banca Inicial do Ciclo (R$)</label><input type="number" id="bankroll-input" value="${state.currentBanca.valor_inicial}" class="input-field"></div>
                        <div><label for="daily-goal-input" class="block text-sm font-medium text-gray-300 mb-2">Meta de Lucro (%)</label><input type="number" id="daily-goal-input" value="${state.currentBanca.meta_diaria_percentual}" class="input-field"></div>
                        <button id="save-settings-btn" class="btn btn-primary w-full"><i class="fas fa-save mr-2"></i>Salvar Configurações</button>
                    </div>
                `;
            }
            function renderDailyGoal() {
                const todayStr = getLocalDateString();
                const todayMeta = state.metasDiarias.find(m => m.data === todayStr);
                const cycleProfit = state.jogadas.reduce((acc, j) => acc + (j.retorno - j.valor_apostado), 0);
                const startOfCycleBankroll = state.currentBanca.valor_inicial;
                const targetProfit = state.currentBanca.meta_diaria_percentual > 0 ? startOfCycleBankroll * (state.currentBanca.meta_diaria_percentual / 100) : 0;
                const dayIsClosed = todayMeta && todayMeta.status === 'concluida';

                document.getElementById('daily-goal-container').innerHTML = `
                    <h2 class="text-xl font-bold mb-4">Meta do Ciclo</h2>
                    <div class="space-y-4">
                        <div class="flex justify-between text-sm"><span class="text-gray-400">Lucro do Ciclo:</span><span class="font-semibold">${formatCurrency(cycleProfit)}</span></div>
                        <div class="flex justify-between text-sm"><span class="text-gray-400">Meta do Ciclo:</span><span class="font-semibold">${formatCurrency(targetProfit)}</span></div>
                        <div id="goal-met-container" class="hidden mt-4 space-y-2 text-center">
                            <h3 id="goal-title" class="text-lg font-bold status-green">Parabéns, meta batida!</h3>
                            <button id="goal-met-btn" class="btn btn-green w-full"><i class="fas fa-flag-checkered mr-2"></i>Fechar Ciclo</button>
                            <button id="new-day-btn" class="btn btn-primary w-full hidden"><i class="fas fa-redo-alt mr-2"></i>Começar Novo Ciclo</button>
                            <p id="goal-met-message" class="text-sm text-gray-300 font-medium"></p>
                        </div>
                    </div>
                `;
                const goalMetContainer = document.getElementById('goal-met-container');
                if (dayIsClosed) {
                    goalMetContainer.classList.remove('hidden');
                    document.getElementById('goal-title').textContent = "Ciclo Concluído!";
                    document.getElementById('goal-met-message').textContent = `O ciclo do dia ${new Date(todayStr + 'T00:00:00').toLocaleDateString('pt-BR')} foi fechado.`;
                    document.getElementById('goal-met-btn').classList.add('hidden');
                    document.getElementById('new-day-btn').classList.remove('hidden');
                } else if (cycleProfit >= targetProfit && targetProfit > 0) {
                    goalMetContainer.classList.remove('hidden');
                }
            }
            function renderBetForm() {
                document.getElementById('bet-form-container').innerHTML = `
                    <h2 class="text-xl font-bold mb-4">Registrar Jogada</h2>
                    <form id="add-bet-form" class="space-y-4">
                        <div><label for="chip-value" class="block text-sm font-medium text-gray-300 mb-2">Valor da Ficha (R$)</label><input type="number" id="chip-value" placeholder="Ex: 1.00" step="0.01" class="input-field"></div>
                        <div><label for="numbers-covered" class="block text-sm font-medium text-gray-300 mb-2">Qtd. Números Cobertos</label><input type="number" id="numbers-covered" placeholder="Ex: 10" class="input-field"></div>
                        <div><label for="zero-stake" class="block text-sm font-medium text-gray-300 mb-2">Proteção no Zero (R$)</label><input type="number" id="zero-stake" placeholder="Deixe em branco" step="0.01" class="input-field"></div>
                        <div class="grid grid-cols-1 gap-3 pt-2">
                            <button type="submit" name="win_number" class="btn btn-green"><i class="fas fa-check-circle mr-2"></i>Vitória em Número</button>
                            <button type="submit" name="win_zero" class="btn btn-blue"><i class="fas fa-star mr-2"></i>Vitória no Zero</button>
                            <button type="submit" name="loss" class="btn btn-red"><i class="fas fa-times-circle mr-2"></i>Derrota</button>
                        </div>
                    </form>
                `;
                const todayStr = getLocalDateString();
                const todayMeta = state.metasDiarias.find(m => m.data === todayStr);
                if (todayMeta && todayMeta.status === 'concluida') {
                    document.getElementById('add-bet-form').querySelectorAll('input, button').forEach(el => el.disabled = true);
                }
            }
            function renderBets() {
                let rows = "";
                state.jogadas.forEach(bet => {
                    const profit = bet.retorno - bet.valor_apostado;
                    rows += `
                        <tr class="border-b border-gray-800 hover:bg-gray-700/50">
                            <td class="p-3 text-sm text-gray-400">${new Date(bet.data_jogada).toLocaleTimeString('pt-BR')}</td>
                            <td class="p-3 text-right">${formatCurrency(bet.valor_apostado)}</td>
                            <td class="p-3 text-right">${formatCurrency(bet.retorno)}</td>
                            <td class="p-3 text-right ${profit > 0 ? 'status-green' : 'status-red'}">${formatCurrency(profit)}</td>
                            <td class="p-3 text-center">${bet.status.startsWith('win') ? '<span class="status-green">Ganha</span>' : '<span class="status-red">Perdida</span>'}</td>
                            <td class="p-3 text-center"><button class="text-red-500 hover:text-red-400 delete-btn" data-id="${bet.id}"><i class="fas fa-trash-alt"></i></button></td>
                        </tr>
                    `;
                });
                document.getElementById('bets-history-container').innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Histórico de Jogadas do Ciclo</h2>
                        <button id="clear-data-btn" class="text-sm text-red-500 hover:text-red-400 font-semibold"><i class="fas fa-trash-alt mr-1"></i> Limpar Jogadas do Ciclo</button>
                    </div>
                    <div class="overflow-x-auto"><table class="w-full text-left">
                        <thead class="border-b border-gray-700 text-sm text-gray-400">
                            <tr><th class="p-3">Data/Hora</th><th class="p-3 text-right">Apostado</th><th class="p-3 text-right">Retorno</th><th class="p-3 text-right">Lucro/Prejuízo</th><th class="p-3 text-center">Status</th><th class="p-3 text-center">Ações</th></tr>
                        </thead>
                        <tbody>${rows || `<tr><td colspan="6" class="text-center text-gray-500 py-8">Nenhuma jogada registrada neste ciclo.</td></tr>`}</tbody>
                    </table></div>
                `;
            }
            function renderProjection() {
                let rows = "";
                let bankrollForProjection = state.metasDiarias[0]?.banca_inicial || state.currentBanca.valor_inicial;

                state.metasDiarias.forEach(meta => {
                    rows += `
                        <tr class="bg-green-900/50">
                            <td class="p-3 text-sm text-gray-400">${new Date(meta.data + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                            <td class="p-3 text-right">${formatCurrency(bankrollForProjection)}</td>
                            <td class="p-3 text-right status-green">${formatCurrency(meta.lucro_final)}</td>
                            <td class="p-3 text-right font-semibold">${formatCurrency(meta.banca_final)}</td>
                            <td class="p-3 text-center"><span class="status-green font-semibold">Alcançado ✅</span></td>
                        </tr>
                    `;
                    bankrollForProjection = meta.banca_final;
                });

                const cycleProfit = state.jogadas.reduce((acc, j) => acc + (j.retorno - j.valor_apostado), 0);
                const currentDayBankroll = state.currentBanca.valor_inicial + cycleProfit;

                let projectionStartBankroll = state.metasDiarias.length > 0 ? state.metasDiarias[state.metasDiarias.length - 1].banca_final : state.currentBanca.valor_inicial;
                if (state.jogadas.length > 0) {
                    projectionStartBankroll = currentDayBankroll;
                }

                for (let i = 0; i < 15; i++) {
                    const lastDate = state.metasDiarias.length > 0 ? new Date(state.metasDiarias[state.metasDiarias.length - 1].data + 'T00:00:00') : new Date(new Date().setDate(new Date().getDate() - 1));
                    const date = new Date(lastDate); date.setDate(lastDate.getDate() + i + 1);
                    const initialProjected = bankrollForProjection;
                    const goal = state.currentBanca.meta_diaria_percentual > 0 ? initialProjected * (state.currentBanca.meta_diaria_percentual / 100) : 0;
                    const finalProjected = initialProjected + goal;
                    rows += `
                        <tr>
                            <td class="p-3 text-sm text-gray-400">${date.toLocaleDateString('pt-BR')}</td>
                            <td class="p-3 text-right">${formatCurrency(initialProjected)}</td>
                            <td class="p-3 text-right status-green">${formatCurrency(goal)}</td>
                            <td class="p-3 text-right font-semibold">${formatCurrency(finalProjected)}</td>
                            <td class="p-3 text-center">Pendente</td>
                        </tr>
                    `;
                    bankrollForProjection = finalProjected;
                }
                document.getElementById('projection-container').innerHTML = `
                    <h2 class="text-xl font-bold mb-4">Histórico de Metas e Projeção Futura</h2>
                    <div class="overflow-x-auto"><table class="w-full text-left">
                        <thead class="border-b border-gray-700 text-sm text-gray-400">
                            <tr><th class="p-3">Data</th><th class="p-3 text-right">Banca Inicial do Ciclo</th><th class="p-3 text-right">Lucro do Ciclo (R$)</th><th class="p-3 text-right">Banca Final do Ciclo</th><th class="p-3 text-center">Status</th></tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table></div>
                `;
            }

            function setupEvents() {
                const logoutBtn = document.getElementById("logout-btn");
                if (logoutBtn && !logoutBtn.dataset.listener) {
                    logoutBtn.dataset.listener = 'true';
                    logoutBtn.addEventListener("click", async () => { await db.auth.signOut(); location.reload(); });
                }

                const saveSettingsBtn = document.getElementById("save-settings-btn");
                if (saveSettingsBtn && !saveSettingsBtn.dataset.listener) {
                    saveSettingsBtn.dataset.listener = 'true';
                    saveSettingsBtn.addEventListener("click", async () => {
                        const newBankroll = parseFloat(document.getElementById('bankroll-input').value);
                        const newGoal = parseFloat(document.getElementById('daily-goal-input').value);
                        if (isNaN(newBankroll) || isNaN(newGoal)) { return alert('Valores inválidos.'); }
                        const { data, error } = await db.from('bancas').update({ valor_inicial: newBankroll, meta_diaria_percentual: newGoal }).eq('id', state.currentBanca.id).select().single();
                        if (error) { alert('Erro ao salvar: ' + error.message); } else { updateState({ currentBanca: data }); alert('Configurações salvas!'); }
                    });
                }

                const addBetForm = document.getElementById("add-bet-form");
                if (addBetForm && !addBetForm.dataset.listener) {
                    addBetForm.dataset.listener = 'true';
                    addBetForm.addEventListener("submit", async (e) => {
                        e.preventDefault();
                        const outcome = e.submitter.name;
                        const chipValue = parseFloat(document.getElementById('chip-value').value) || 0;
                        const numbersCovered = parseInt(document.getElementById('numbers-covered').value) || 0;
                        const zeroStake = parseFloat(document.getElementById('zero-stake').value) || 0;

                        if (chipValue < 0 || numbersCovered < 0 || zeroStake < 0) {
                            alert('Valores não podem ser negativos.');
                            return;
                        }
                        if (outcome === 'win_number' && (chipValue <= 0 || numbersCovered <= 0)) {
                            alert('Preencha o valor da ficha e a quantidade de números cobertos corretamente.');
                            return;
                        }
                        if (outcome === 'win_zero' && zeroStake <= 0) {
                            alert('Preencha o valor da proteção no zero corretamente.');
                            return;
                        }
                        const totalStake = (chipValue * numbersCovered) + zeroStake;
                        if (totalStake <= 0) {
                            alert("Valor apostado inválido.");
                            return;
                        }
                        let result = 0, status = '';
                        if (outcome === 'win_number') { result = chipValue * 36; status = 'win'; }
                        else if (outcome === 'win_zero') { result = zeroStake * 36; status = 'win_zero'; }
                        else if (outcome === 'loss') { result = 0; status = 'loss'; }
                        const { data: newBet, error } = await db.from('jogadas').insert({ banca_id: state.currentBanca.id, valor_apostado: totalStake, retorno: result, status: status, estrategia: 'Jogada Manual' }).select().single();
                        if (error) { alert("Erro ao registrar jogada: " + error.message); } else { updateState({ jogadas: [newBet, ...state.jogadas] }); document.getElementById('add-bet-form').reset(); }
                    });
                }

                const clearDataBtn = document.getElementById("clear-data-btn");
                if (clearDataBtn && !clearDataBtn.dataset.listener) {
                    clearDataBtn.dataset.listener = 'true';
                    clearDataBtn.addEventListener("click", async () => {
                        if (!confirm("Tem certeza?")) return;
                        await db.from("jogadas").delete().eq("banca_id", state.currentBanca.id);
                        updateState({ jogadas: [] });
                    });
                }

                const goalMetBtn = document.getElementById("goal-met-btn");
                if (goalMetBtn && !goalMetBtn.dataset.listener) {
                    goalMetBtn.dataset.listener = 'true';
                    goalMetBtn.addEventListener("click", async () => {
                        const todayStr = getLocalDateString();
                        const cycleProfit = state.jogadas.reduce((acc, j) => acc + (j.retorno - j.valor_apostado), 0);
                        const finalBankroll = state.currentBanca.valor_inicial + cycleProfit;
                        const { data: newMeta, error } = await db.from('metas_diarias').upsert({ user_id: state.currentUser.id, banca_id: state.currentBanca.id, data: todayStr, status: 'concluida', lucro_final: cycleProfit, banca_final: finalBankroll }, { onConflict: 'banca_id, data' }).select().single();
                        if (!error) {
                            const index = state.metasDiarias.findIndex(m => m.data === todayStr);
                            if (index > -1) state.metasDiarias[index] = newMeta; else state.metasDiarias.push(newMeta);
                            updateState({ metasDiarias: [...state.metasDiarias] });
                        } else {
                            alert('Erro ao fechar ciclo: ' + error.message);
                        }
                    });
                }

                const newDayBtn = document.getElementById("new-day-btn");
                if (newDayBtn && !newDayBtn.dataset.listener) {
                    newDayBtn.dataset.listener = 'true';
                    newDayBtn.addEventListener("click", async () => {
                        const btn = document.getElementById("new-day-btn");
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Iniciando...';
                        try {
                            const finalBankroll = state.currentBanca.valor_inicial + state.jogadas.reduce((acc, j) => acc + (j.retorno - j.valor_apostado), 0);
                            await db.from('bancas').update({ valor_inicial: finalBankroll }).eq('id', state.currentBanca.id);
                            await db.from('jogadas').delete().eq('banca_id', state.currentBanca.id);
                            location.reload();
                        } catch (error) {
                            alert('Ocorreu um erro: ' + error.message);
                            btn.disabled = false;
                            btn.innerHTML = '<i class="fas fa-redo-alt mr-2"></i>Começar Novo Ciclo';
                        }
                    });
                }

                const betsHistoryContainer = document.getElementById("bets-history-container");
                if (betsHistoryContainer && !betsHistoryContainer.dataset.listener) {
                    betsHistoryContainer.dataset.listener = 'true';
                    betsHistoryContainer.addEventListener("click", async (e) => {
                        if (e.target.closest('.delete-btn')) {
                            const button = e.target.closest('.delete-btn');
                            const idToDelete = button.getAttribute('data-id');
                            if(confirm('Apagar esta jogada?')){
                                await db.from('jogadas').delete().eq('id', idToDelete);
                                updateState({ jogadas: state.jogadas.filter(j => j.id != idToDelete) });
                            }
                        }
                    });
                }
            }

            loginForm.addEventListener("submit", async (e) => { e.preventDefault(); authErrorEl.textContent = ''; const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; const { error } = await db.auth.signInWithPassword({ email, password }); if (error) { authErrorEl.textContent = 'Email ou senha inválidos.'; } else { location.reload(); } });
            registerForm.addEventListener("submit", async (e) => { e.preventDefault(); registerMessageEl.textContent = ''; const email = document.getElementById('register-email').value; const password = document.getElementById('register-password').value; const { error } = await db.auth.signUp({ email, password }); if (error) { alert(`Erro ao cadastrar: ${error.message}`); } else { registerMessageEl.textContent = 'Cadastro realizado! Verifique seu e-mail para confirmar a conta.'; } });
            showRegisterLink.addEventListener("click", (e) => { e.preventDefault(); document.getElementById("login-view").classList.add("hidden"); document.getElementById("register-view").classList.remove("hidden"); });
            showLoginLink.addEventListener("click", (e) => { e.preventDefault(); document.getElementById("register-view").classList.add("hidden"); document.getElementById("login-view").classList.remove("hidden"); });

            async function checkUserSession() {
                const { data: { session } } = await db.auth.getSession();
                if (session) {
                    updateState({ currentUser: session.user });
                    authContainer.classList.add("hidden"); dashboardContainer.classList.remove("hidden");
                    await loadDashboardData();
                } else {
                    dashboardContainer.classList.add("hidden"); authContainer.classList.remove("hidden");
                }
            };
            checkUserSession();
        });
    </script>
</body>
</html>
