<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gest칚o de Banca para Roleta</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f3f4f6; }
    .card { background-color: #1f2937; border-radius: 0.75rem; padding: 1.5rem; border: 1px solid #374151; }
    .btn { color: white; font-weight: 600; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: background-color 0.3s ease, transform 0.1s ease; border: none; cursor: pointer; }
    .btn:disabled { background-color: #4b5563; cursor: not-allowed; }
    .btn:active:not(:disabled) { transform: scale(0.98); }
    .btn-green { background-color: #16a34a; } .btn-green:hover:not(:disabled) { background-color: #15803d; }
    .btn-red { background-color: #dc2626; } .btn-red:hover:not(:disabled) { background-color: #b91c1c; }
    .btn-blue { background-color: #2563eb; } .btn-blue:hover:not(:disabled) { background-color: #1d4ed8; }
    .btn-primary { background-color: #3b82f6; } .btn-primary:hover:not(:disabled) { background-color: #2563eb; }
    .input-field { background-color: #374151; border: 1px solid #4b5563; color: #f3f4f6; border-radius: 0.5rem; padding: 0.75rem; width: 100%; }
    .input-field:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px #1e40af; }
    .hidden { display: none; }
    .status-green { color: #22c55e; } .status-red { color: #ef4444; }
    .achieved-row { background-color: #22c55e; color: #111827; font-weight: bold; }
  </style>
</head>
<body class="p-4 md:p-8">

  <!-- TELA DE AUTENTICA칂츾O -->
  <div id="auth-container" class="max-w-md mx-auto hidden">
    <div class="card">
      <div id="login-view">
        <h2 class="text-2xl font-bold text-center mb-6">Login</h2>
        <form id="login-form" class="space-y-4">
          <div><label for="login-email" class="block text-sm font-medium text-gray-300 mb-2">Email</label><input type="email" id="login-email" class="input-field" required></div>
          <div><label for="login-password" class="block text-sm font-medium text-gray-300 mb-2">Senha</label><input type="password" id="login-password" class="input-field" required></div>
          <button type="submit" class="btn btn-primary w-full">Entrar</button>
          <p id="auth-error" class="text-red-500 text-sm text-center h-4"></p>
        </form>
        <p class="text-center mt-4 text-sm">N칚o tem uma conta? <a href="#" id="show-register-link" class="font-semibold text-blue-400 hover:underline">Cadastre-se</a></p>
      </div>
      <div id="register-view" class="hidden">
        <h2 class="text-2xl font-bold text-center mb-6">Criar Conta</h2>
        <form id="register-form" class="space-y-4">
          <div><label for="register-email" class="block text-sm font-medium text-gray-300 mb-2">Email</label><input type="email" id="register-email" class="input-field" required></div>
          <div><label for="register-password" class="block text-sm font-medium text-gray-300 mb-2">Senha</label><input type="password" id="register-password" class="input-field" required></div>
          <button type="submit" class="btn btn-primary w-full">Cadastrar</button>
          <p id="register-message" class="text-green-500 text-sm text-center h-4"></p>
        </form>
        <p class="text-center mt-4 text-sm">J치 tem uma conta? <a href="#" id="show-login-link" class="font-semibold text-blue-400 hover:underline">Fa칞a o login</a></p>
      </div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard-container" class="max-w-7xl mx-auto hidden">
    <!-- O conte칰do ser치 injetado aqui pelo JS -->
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const { createClient } = supabase;
      const supabaseUrl = 'https://dekubpsswkfrtotwljvf.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRla3VicHNzd2tmcnRvdHdsanZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNzYyOTAsImV4cCI6MjA3MzY1MjI5MH0.Winuq2LIkaGt1sGNXUhi__Q5_AczyxKAYQ_ORABoPTk';
      const db = createClient(supabaseUrl, supabaseKey);

      let currentUser = null, currentBanca = null, jogadas = [], metasDiarias = [];

      const authContainer = document.getElementById('auth-container'),
            dashboardContainer = document.getElementById('dashboard-container');
      const loginForm = document.getElementById('login-form'), registerForm = document.getElementById('register-form');
      const showRegisterLink = document.getElementById('show-register-link'), showLoginLink = document.getElementById('show-login-link');
      const authErrorEl = document.getElementById('auth-error'), registerMessageEl = document.getElementById('register-message');

      const formatCurrency = (v) => (v === null || v === undefined ? 0 : v).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
      const getLocalDateString = (d) => {
        const date = d ? new Date(d) : new Date();
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
      };

      async function loadDashboardData() {
        if (!currentUser) return;
        const { data: bancaData, error: bancaError } = await db.from("bancas").select("*").eq("user_id", currentUser.id).single();
        if (bancaData) currentBanca = bancaData;
        else if (!bancaError || bancaError.code === 'PGRST116') {
          const { data: newBanca } = await db.from("bancas").insert({ user_id: currentUser.id, nome_banca: "Banca Principal", valor_inicial: 100, meta_diaria_percentual: 25 }).select().single();
          currentBanca = newBanca;
        }
        if (!currentBanca) return;

        const [jogadasRes, metasRes] = await Promise.all([
          db.from("jogadas").select("*").eq("banca_id", currentBanca.id).order("data_jogada", { ascending: false }),
          db.from("metas_diarias").select("*").eq("banca_id", currentBanca.id).order("data", { ascending: true })
        ]);
        jogadas = jogadasRes.data || [];
        metasDiarias = metasRes.data || [];
        renderAll();
      }

      function renderAll() {
        if (!currentBanca) { dashboardContainer.innerHTML = `<p class="text-center text-red-500">N칚o foi poss칤vel carregar dados.</p>`; return; }
        
        dashboardContainer.innerHTML = `
          <header class="mb-8 flex flex-wrap justify-between items-center gap-4">
            <div><h1 class="text-3xl md:text-4xl font-bold text-white"><i class="fas fa-compact-disc mr-3 text-red-500"></i>Gest칚o de Banca</h1><p class="text-gray-400 mt-2 text-sm">Logado como: ${currentUser.email}</p></div>
            <button id="logout-btn" class="btn btn-red"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button>
          </header>
          <section id="metrics-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6 mb-8"></section>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <div class="lg:col-span-1 space-y-8">
              <div id="settings-container" class="card"></div>
              <div id="daily-goal-container" class="card"></div>
              <div id="bet-form-container" class="card"></div>
            </div>
            <div id="bets-history-container" class="lg:col-span-2 card"></div>
          </div>
          <div id="projection-container" class="card mb-8"></div>
        `;
        
        renderMetrics(); 
        renderSettings(); 
        renderDailyGoal(); 
        renderBetForm(); 
        renderBets(); 
        renderProjection();
        
        setupEvents();
      }

      // 游댠 Ajustado: s칩 libera nova meta no dia seguinte
      function renderDailyGoal() {
        const todayStr = getLocalDateString();
        const todayMeta = metasDiarias.find(m => m.data === todayStr);
        const cycleProfit = jogadas.reduce((acc, j) => acc + (j.retorno - j.valor_apostado), 0);
        const startOfCycleBankroll = currentBanca.valor_inicial;
        const targetProfit = currentBanca.meta_diaria_percentual > 0 ? startOfCycleBankroll * (currentBanca.meta_diaria_percentual / 100) : 0;

        document.getElementById('daily-goal-container').innerHTML = `
          <h2 class="text-xl font-bold mb-4">Meta do Ciclo</h2>
          <div class="space-y-4">
            <div class="flex justify-between text-sm"><span class="text-gray-400">Lucro do Ciclo:</span><span class="font-semibold">${formatCurrency(cycleProfit)}</span></div>
            <div class="flex justify-between text-sm"><span class="text-gray-400">Meta do Ciclo:</span><span class="font-semibold">${formatCurrency(targetProfit)}</span></div>
            <div id="goal-met-container" class="hidden mt-4 space-y-2 text-center">
              <h3 id="goal-title" class="text-lg font-bold status-green">Parab칠ns, meta batida!</h3>
              <button id="goal-met-btn" class="btn btn-green w-full"><i class="fas fa-flag-checkered mr-2"></i>Fechar Ciclo e Iniciar Novo</button>
              <p id="goal-met-message" class="text-sm text-gray-300 font-medium"></p>
            </div>
          </div>
        `;

        const goalMetContainer = document.getElementById('goal-met-container');
        if (todayMeta && todayMeta.status === 'concluida') {
          goalMetContainer.classList.remove('hidden');
          document.getElementById('goal-title').textContent = "Ciclo Conclu칤do!";
          document.getElementById('goal-met-message').textContent = `O ciclo do dia ${new Date(todayStr + 'T00:00:00').toLocaleDateString('pt-BR')} foi fechado.`;
          document.getElementById('goal-met-btn').classList.add('hidden'); // 游댠 N칚o cria nova meta no mesmo dia
        } else if (cycleProfit >= targetProfit && targetProfit > 0) {
          goalMetContainer.classList.remove('hidden');
        }
      }

      // Eventos
      function setupEvents() {
        document.getElementById("logout-btn")?.addEventListener("click", async () => { await db.auth.signOut(); location.reload(); });

        // 游댠 Ajustado: s칩 cria pr칩xima meta no dia seguinte
        document.getElementById("goal-met-btn")?.addEventListener("click", async () => {
          const todayStr = getLocalDateString();
          const cycleProfit = jogadas.reduce((acc, j) => acc + (j.retorno - j.valor_apostado), 0);
          const finalBankroll = currentBanca.valor_inicial + cycleProfit;

          const { data: newMeta, error } = await db.from('metas_diarias').upsert({
            user_id: currentUser.id,
            banca_id: currentBanca.id,
            data: todayStr,
            status: 'concluida',
            lucro_final: cycleProfit,
            banca_final: finalBankroll,
            banca_inicial: currentBanca.valor_inicial
          }, { onConflict: 'banca_id, data' }).select().single();

          if (!error) {
            const index = metasDiarias.findIndex(m => m.data === todayStr);
            if (index > -1) metasDiarias[index] = newMeta; else metasDiarias.push(newMeta);
            await db.from('bancas').update({ valor_inicial: finalBankroll }).eq('id', currentBanca.id);
            await db.from('jogadas').delete().eq('banca_id', currentBanca.id);
            jogadas = [];
            currentBanca.valor_inicial = finalBankroll;
            renderAll();
            alert("Ciclo conclu칤do! Nova meta ser치 liberada amanh칚.");
          } else {
            alert('Erro ao fechar ciclo: ' + error.message);
          }
        });
      }

      // Login / Registro
      loginForm.addEventListener("submit", async (e) => { e.preventDefault(); authErrorEl.textContent = ''; const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; const { error } = await db.auth.signInWithPassword({ email, password }); if (error) { authErrorEl.textContent = 'Email ou senha inv치lidos.'; } else { location.reload(); } });
      registerForm.addEventListener("submit", async (e) => { e.preventDefault(); registerMessageEl.textContent = ''; const email = document.getElementById('register-email').value; const password = document.getElementById('register-password').value; const { error } = await db.auth.signUp({ email, password }); if (error) { alert(`Erro ao cadastrar: ${error.message}`); } else { registerMessageEl.textContent = 'Cadastro realizado! Verifique seu e-mail para confirmar a conta.'; } });
      showRegisterLink.addEventListener("click", (e) => { e.preventDefault(); document.getElementById("login-view").classList.add("hidden"); document.getElementById("register-view").classList.remove("hidden"); });
      showLoginLink.addEventListener("click", (e) => { e.preventDefault(); document.getElementById("register-view").classList.add("hidden"); document.getElementById("login-view").classList.remove("hidden"); });

      async function checkUserSession() {
        const { data: { session } } = await db.auth.getSession();
        if (session) {
          currentUser = session.user;
          authContainer.classList.add("hidden"); dashboardContainer.classList.remove("hidden");
          await loadDashboardData();
        } else {
          dashboardContainer.classList.add("hidden"); authContainer.classList.remove("hidden");
        }
      };
      checkUserSession();
    });
  </script>
</body>
</html>
